<html>
<head>
    <link rel="stylesheet" type="text/css" href="./css/style.css" />

    <script src="./js/jquery.js" type="text/javascript"></script>
    <script type="text/javascript" src="http://static.wowhead.com/widgets/power.js"></script>

    <script type="text/javascript">

        // Colors from http://www.wowwiki.com/Class_colors
        var CLASS_COLORS = {
            'Death Knight': '#C41F3B',
            'Druid':        '#FF7D0A',
            'Hunter':       '#ABD473',
            'Mage':         '#69CCF0',
            'Monk':         '#558A84',
            'Paladin':      '#F58CBA',
            'Priest':       '#E0E0E0', // original is '#FFFFFF', but white on white...
            'Rogue':        '#FFd539', // oritinal is '#FFF569', but not great on white...
            'Shaman':       '#0070DE',
            'Warlock':      '#9482C9',
            'Warrior':      '#C79C6E',
        };

        var DEFAULT_CLASS_COLOR = '#808080';

        var QUALITY_COLORS = {
            'Common':    '#E0E0E0',
            'Uncommon':  '#1EFF00',
            'Rare':      '#0070FF',
            'Epic':      '#A335EE',
            'Legendary': '#FF8000',
            'Heirloom':  '#E6CC80',
        };

        var DEFAULT_QUALITY_COLOR = '#9D9D9D';


        function getClassColor(name)
        {
            if (CLASS_COLORS[name] !== undefined)
                return CLASS_COLORS[name];

            return DEFAULT_CLASS_COLOR;
        }


        function getQualityColor(name)
        {
            if (QUALITY_COLORS[name] !== undefined)
                return QUALITY_COLORS[name];

            return DEFAULT_QUALITY_COLOR;
        }


        function processEquipmentOverview(data, table_id)
        {
            var parent = $('#' + table_id + ' tbody')[0];

            for (var i = 0; i < data.characters.length; ++i)
            {
                var character = data.characters[i];

                for (var j = 0; j < character.specs.length; ++j)
                {
                    var spec = character.specs[j];

                    if (spec.ilvl == null)
                        continue;

                    var tr = document.createElement('tr');
                    parent.appendChild(tr);

                    // Name
                    var td = document.createElement('td');
                    tr.appendChild(td);

                    var a = document.createElement('a');
                    a.href = character.armory_url;
                    a.textContent = character.name;
                    a.style.color = getClassColor(character.class);
                    td.appendChild(a);

                    // Role
                    td = document.createElement('td');
                    td.className = 'role';
                    tr.appendChild(td);

                    img = document.createElement('img');
                    img.src = spec.icon;
                    td.appendChild(img);

                    span = document.createElement('span');
                    span.textContent = spec.role;
                    td.appendChild(span);

                    // iLevel
                    td = document.createElement('td');
                    td.className = 'centered';
                    tr.appendChild(td);

                    span = document.createElement('span');
                    span.className = 'progressbar';
                    $(span).html('&nbsp;');

                    if (spec.ilvl >= 450)
                    {
                        if (spec.ilvl < 600)
                        {
                            span.style.width = '' + (spec.ilvl - 450) * 2 + 'px';
                        }
                        else
                        {
                            span.style.width = '300px';
                            span.className += ' full';
                        }

                        if (spec.ilvl < 500)
                            span.className += ' common';
                        else if (spec.ilvl < 510)
                            span.className += ' uncommon';
                        else if (spec.ilvl < 520)
                            span.className += ' rare';
                        else if (spec.ilvl < 530)
                            span.className += ' epic';
                        else
                            span.className += ' legendary';
                    }
                    else
                    {
                        span.style.width = '0px';
                    }

                    td.appendChild(span);

                    span = document.createElement('span');
                    span.className = 'progressbar_background';
                    $(span).html('&nbsp;');

                    if (spec.ilvl >= 450)
                    {
                        span.style.width = '' + (600 - spec.ilvl) * 2 + 'px';
                    }
                    else
                    {
                        span.style.width = '300px';
                        span.className += ' full';
                    }

                    td.appendChild(span);

                    span = document.createElement('span');
                    span.textContent = spec.ilvl;
                    td.appendChild(span);
                }
            }

            $('#' + table_id + '-progress').hide();
            $('#' + table_id).show();
        }


        function processEquipment(data, table_id)
        {
            function _processSlot(slot, character, spec)
            {
                var row = $('#' + table_id + ' tr[name=' + slot + ']')[0];

                var td = document.createElement('td');
                row.appendChild(td);

                if (spec.items[slot] !== null)
                {
                    var span = document.createElement('span');
                    span.className = 'level';
                    span.textContent = '(' + spec.items[slot].level + ')';
                    td.appendChild(span);

                    if (spec.items[slot].level < spec.ilvl - 10)
                        span.className += ' below';
                    else if (spec.items[slot].level > spec.ilvl + 10)
                        span.className += ' above';

                    var img = document.createElement('img');
                    if (spec.items[slot].upgrade !== null
                        && spec.items[slot].upgrade['current'] < spec.items[slot].upgrade['total'])
                    {
                        img.src = 'images/up-circular-32.png';
                    }
                    else
                    {
                        img.src = 'images/blank.png';
                    }
                    img.width = 12;
                    td.appendChild(img);

                    var img = document.createElement('img');
                    img.src = spec.items[slot].icon;
                    td.appendChild(img);

                    var a = document.createElement('a');
                    a.href = 'http://' + data.locale + '.wowhead.com/item=' + spec.items[slot].id;
                    a.textContent = spec.items[slot].name;
                    a.style.color = getQualityColor(spec.items[slot].quality);
                    td.appendChild(a);

                    a.rel = 'item=' + spec.items[slot].id + '&amp;lvl=' + character.level;

                    if (spec.items[slot].random_enchant)
                        a.rel += '&amp;rand=' + spec.items[slot].random_enchant;

                    if (spec.items[slot].enchant)
                        a.rel += '&amp;ench=' + spec.items[slot].enchant;

                    if (spec.items[slot].gems && (spec.items[slot].gems.length > 0))
                    {
                        a.rel += '&amp;gems=' + spec.items[slot].gems[0];
                        for (var i = 1; i < spec.items[slot].gems.length; ++i)
                            a.rel += ':' + spec.items[slot].gems[i];
                    }

                    if (spec.items[slot].extra_socket)
                        a.rel += '&amp;sock';

                    if (spec.items[slot].reforge)
                        a.rel += '&amp;forg=' + spec.items[slot].reforge;

                    if (spec.items[slot].set && (spec.items[slot].set.length > 0))
                    {
                        a.rel += '&amp;pcs=' + spec.items[slot].set[0];
                        for (var i = 1; i < spec.items[slot].set.length; ++i)
                            a.rel += ':' + spec.items[slot].set[i];
                    }
                }
                else
                {
                    td.textContent = '-';
                }
            }


            var header_row = $('#' + table_id + ' tr[name=characters]')[0];

            for (var i = 0; i < data.characters.length; ++i)
            {
                var character = data.characters[i];

                for (var j = 0; j < character.specs.length; ++j)
                {
                    var spec = character.specs[j];

                    if (spec.ilvl == null)
                        continue;

                    var th = document.createElement('th');
                    header_row.appendChild(th);

                    var a = document.createElement('a');
                    a.href = character.armory_url;
                    a.textContent = character.name;
                    a.style.color = getClassColor(character.class);
                    th.appendChild(a);

                    img = document.createElement('img');
                    img.src = spec.icon;
                    th.appendChild(img);

                    span = document.createElement('span');
                    span.textContent = spec.role;
                    th.appendChild(span);

                    _processSlot('main_hand', character, spec);
                    _processSlot('off_hand', character, spec);
                    _processSlot('head', character, spec);
                    _processSlot('neck', character, spec);
                    _processSlot('shoulder', character, spec);
                    _processSlot('back', character, spec);
                    _processSlot('chest', character, spec);
                    _processSlot('wrist', character, spec);
                    _processSlot('hands', character, spec);
                    _processSlot('waist', character, spec);
                    _processSlot('legs', character, spec);
                    _processSlot('feet', character, spec);
                    _processSlot('finger1', character, spec);
                    _processSlot('finger2', character, spec);
                    _processSlot('trinket1', character, spec);
                    _processSlot('trinket2', character, spec);
                }
            }

            $('#' + table_id + '-progress').hide();
            $('#' + table_id).show();
        }


        function processModifications(data, table_id)
        {
            function _processSlot(slot, spec)
            {
                var row = $('#' + table_id + ' tr[name=' + slot + ']')[0];

                var td = document.createElement('td');
                row.appendChild(td);

                if (spec.valid_modifications)
                {
                    if (spec.modifications[slot])
                    {
                        var ul = document.createElement('ul');
                        td.appendChild(ul);

                        if (spec.modifications[slot].gems !== null)
                        {
                            for (var i = 0; i < spec.modifications[slot].gems.length; ++i)
                            {
                                if (spec.modifications[slot].gems[i])
                                {
                                    var li = document.createElement('li');
                                    li.className = 'gem';
                                    ul.appendChild(li);

                                    var gem = data.items['' + spec.modifications[slot].gems[i]];
                                    if (gem)
                                    {
                                        var img = document.createElement('img');
                                        img.src = "http://eu.media.blizzard.com/wow/icons/18/" + gem.icon + '.jpg';
                                        li.appendChild(img);
                                
                                        var a = document.createElement('a');
                                        a.href = 'http://' + data.locale + '.wowhead.com/item=' + gem.id;
                                        a.textContent = gem.name;
                                        a.style.color = getQualityColor(Object.keys(QUALITY_COLORS)[gem.quality - 1]);
                                        li.appendChild(a);
                                    }
                                    else
                                    {
                                        li.textContent = 'Unknown (' + spec.modifications[slot].gems[i] + ')';
                                    }
                                }
                            }
                        }

                        if (spec.modifications[slot].enchant !== null)
                        {
                            var li = document.createElement('li');
                            li.className = 'enchant';
                            li.textContent = spec.modifications[slot].enchant;
                            ul.appendChild(li);
                        }

                        if (spec.modifications[slot].reforge !== null)
                        {
                            var li = document.createElement('li');
                            li.className = 'reforge';
                            li.textContent = spec.modifications[slot].reforge;
                            ul.appendChild(li);
                        }
                    }
                }
                else
                {
                    td.style.backgroundColor = '#777777';
                }
            }


            var header_row = $('#' + table_id + ' tr[name=characters]')[0];

            for (var i = 0; i < data.characters.length; ++i)
            {
                var character = data.characters[i];

                for (var j = 0; j < character.specs.length; ++j)
                {
                    var spec = character.specs[j];

                    if (spec.ilvl == null)
                        continue;

                    var th = document.createElement('th');
                    header_row.appendChild(th);

                    var a = document.createElement('a');
                    a.href = character.armory_url;
                    a.textContent = character.name;
                    a.style.color = getClassColor(character.class);
                    th.appendChild(a);

                    img = document.createElement('img');
                    img.src = spec.icon;
                    th.appendChild(img);

                    span = document.createElement('span');
                    span.textContent = spec.role;
                    th.appendChild(span);

                    _processSlot('main_hand', spec);
                    _processSlot('off_hand', spec);
                    _processSlot('head', spec);
                    _processSlot('neck', spec);
                    _processSlot('shoulder', spec);
                    _processSlot('back', spec);
                    _processSlot('chest', spec);
                    _processSlot('wrist', spec);
                    _processSlot('hands', spec);
                    _processSlot('waist', spec);
                    _processSlot('legs', spec);
                    _processSlot('feet', spec);
                    _processSlot('finger1', spec);
                    _processSlot('finger2', spec);
                    _processSlot('trinket1', spec);
                    _processSlot('trinket2', spec);
                }
            }

            $('#' + table_id + '-progress').hide();
            $('#' + table_id).show();
        }

        </script>
</head>
<body>

    <a href="https://github.com/Kanma/WoWCharactersViewer">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub" />
    </a>


    <h1>Characters</h1>

    <img id="characters-progress" src="images/progress.gif" />

    <table id="characters" cellspacing="0" cellpadding="0" style="display: none;">
        <thead>
            <tr>
                <th>Name</th>
                <th>Role</th>
                <th>iLevel</th>
            </td>
        </thead>
        <tbody>
        </tbody>
    </table>


    <h1>Equipment</h1>

    <img id="equipment-progress" src="images/progress.gif" />

    <table id="equipment" class="equipment" cellspacing="0" cellpadding="0" style="display: none;">
        <thead>
            <tr name="characters">
                <th class="slot"></th>
            </tr>
        </thead>
        <tbody>
            <tr name="main_hand">
                <td>Main hand</td>
            </tr>
            <tr name="off_hand">
                <td>Off hand</td>
            </tr>
            <tr name="head">
                <td>Head</td>
            </tr>
            <tr name="neck">
                <td>Neck</td>
            </tr>
            <tr name="shoulder">
                <td>Shoulder</td>
            </tr>
            <tr name="back">
                <td>Back</td>
            </tr>
            <tr name="chest">
                <td>Chest</td>
            </tr>
            <tr name="wrist">
                <td>Wrist</td>
            </tr>
            <tr name="hands">
                <td>Hands</td>
            </tr>
            <tr name="waist">
                <td>Waist</td>
            </tr>
            <tr name="legs">
                <td>Legs</td>
            </tr>
            <tr name="feet">
                <td>Feet</td>
            </tr>
            <tr name="finger1">
                <td>Finger 1</td>
            </tr>
            <tr name="finger2">
                <td>Finger 2</td>
            </tr>
            <tr name="trinket1">
                <td>Trinket 1</td>
            </tr>
            <tr name="trinket2">
                <td>Trinket 2</td>
            </tr>
        </tbody>
    </table>


    <h1>Modifications</h1>

    <img id="modifications-progress" src="images/progress.gif" />

    <table id="modifications" class="modifications" cellspacing="0" cellpadding="0" style="display: none;">
        <thead>
            <tr name="characters">
                <th class="slot"></th>
            </tr>
        </thead>
        <tbody>
            <tr name="main_hand">
                <td>Main hand</td>
            </tr>
            <tr name="off_hand">
                <td>Off hand</td>
            </tr>
            <tr name="head">
                <td>Head</td>
            </tr>
            <tr name="neck">
                <td>Neck</td>
            </tr>
            <tr name="shoulder">
                <td>Shoulder</td>
            </tr>
            <tr name="back">
                <td>Back</td>
            </tr>
            <tr name="chest">
                <td>Chest</td>
            </tr>
            <tr name="wrist">
                <td>Wrist</td>
            </tr>
            <tr name="hands">
                <td>Hands</td>
            </tr>
            <tr name="waist">
                <td>Waist</td>
            </tr>
            <tr name="legs">
                <td>Legs</td>
            </tr>
            <tr name="feet">
                <td>Feet</td>
            </tr>
            <tr name="finger1">
                <td>Finger 1</td>
            </tr>
            <tr name="finger2">
                <td>Finger 2</td>
            </tr>
            <tr name="trinket1">
                <td>Trinket 1</td>
            </tr>
            <tr name="trinket2">
                <td>Trinket 2</td>
            </tr>
        </tbody>
    </table>


    <script type="text/javascript">
        window.onload = function ()
        {
            $.get('data.json', function(data) {
                // By security, in case the server doesn't return the correct mime type
                if (typeof(data) == "string")
                    data = JSON.parse(data);

                processEquipmentOverview(data, 'characters');
                processEquipment(data, 'equipment');
                processModifications(data, 'modifications');
            });
        }
    </script>
</html>
